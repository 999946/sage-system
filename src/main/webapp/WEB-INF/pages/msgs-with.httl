<!DOCTYPE html>
<html>
#set(components = ["bootstrap", "layout", "tag", "user"])
#set(UserSelf userSelf)
#set(MessageList messageList)
#set(Map<Long, UserLabel> users)
#set(withUserId = messageList.withUser.id)
<head>
  <meta charset="UTF-8">
  <title></title>
  $!{includeCSS()}
  <style>
    .msg{
      width: 200px;
      margin-top: 10px;
    }
    .from-other{
      margin-right: 150px;
    }
    .from-self{
      margin-left: 150px;
    }

    .msg-body{
      padding: 5px;
      border-radius: 5px;
    }
    .from-other .msg-body{
      background: lightblue;
    }
    .from-self .msg-body{
      background: #A7E8A7;
    }

    .msg-from{
      padding: 2px;
    }
    .from-other .msg-from{
      float: left;
      margin-right: 5px;
    }
    .from-self .msg-from{
      float: right;
      margin-left: 5px;
    }

    .msg-time{
      color: gray;
    }

    #input-box{
      margin: 20px;
    }
    .input{
      width: 20em;
      border-radius: 5px;
      border: 0;
      resize: none;
      outline: none;
      padding: 5px;
    }
    .input:focus{
      border: 1px solid #fa7d3c;
    }
  </style>
</head>
<body>
$!{include("navbar.httl")}
<div id="container" class="container">
  <div id="conversation">
  #for(Message msg : messageList.msgs)
    #if(msg.fromUser == userSelf.id)
      #set(msgClass = 'from-self')
    #else
      #set(msgClass = 'from-other')
    #end
    <div class="msg ${msgClass}" data-id="${msg.id}">
      <div class="msg-from">
        $!{include("user-label.httl", ["u": users[msg.fromUser]])}
      </div>
      <div class="msg-body">
        <span class="msg-time">${humanTime(msg.time)}</span>
        <div class="msg-content">${msg.content}</div>
      </div>
    </div>
  #end
  </div>
  <div id="input-box" data-post="/message/send?to=${withUserId}" data-loadmore="/pages/message/more?withUser=${withUserId}">
    <textarea class="input" placeholder="输入"></textarea>
    <button class="btn btn-sm" type="submit">发送</button>
  </div>
</div>
$!{includeProto}
$!{includeJS()}
<script>
  window.msgIds = {}
  $('.msg').each(function(){
    var id = parseInt($(this).data('id'))
    if (id) window.msgIds[id] = true
  })

  $('#input-box *[type=submit]').click(function(){
    var $this = $(this)
    var value = $('#input-box .input').val()
    if (value.length == 0) {
      tipover($this, '请输入内容', 1000)
      return
    }
    $this.prop('disabled', true)
    setTimeout(function(){$this.prop('disabled', false)}, 1000)
    $.post($('#input-box').data('post'), {
      content: value
    })
        .done(function(){
          $('#input-box .input').val('')
        })
        .fail(function(){
          tipover($this, '发送遇到问题', 1000)
        })
        .always(loadMoreMsgs)
  })
  setInterval(loadMoreMsgs, 2000)

  function maxMsgId() {
    var max = 0;
    $('.msg').each(function(){
      var id = parseInt($(this).data('id'))
      if (id && id > max) {
        max = id;
      }
    })
    return max;
  }

  function loadMoreMsgs() {
    $.get($('#input-box').data('loadmore'), {afterId: maxMsgId()})
        .done(function(resp){
          var $subdoc = $('<div>').html(resp)
          var $msgs = $subdoc.find('.msg')
          $msgs.each(function(){
            var id = parseInt($(this).data('id'))
            if (!window.msgIds[id]) {
              window.msgIds[id] = true
              $(this).appendTo($('#conversation'))
            }
          })
        })
  }
</script>
</body>
</html>