<!DOCTYPE html>
<html>
<!--
#set(TopicView topic)
#set(List<TopicReplyView> replies)
-->
<head>
  <meta charset="UTF-8">
  <title>${topic.title}</title>
  $!{allcss}
</head>
<body>
$!{include("navbar.httl")}
<div id="container" class="container">
  <div class="topic" data-id="${topic.id}">
    <h3>${topic.title}</h3>
    $!{include("user-label.httl", ["u": topic.author])}
    <span class="human-time" data-time="${topic.whenCreated.time}"></span>
    #if(topic.whenModified > topic.whenCreated)
    <span class="human-time" data-time="${topic.whenModified.time}"></span>
    #end
    <div class="topic-content">${topic.content}</div>
    #for(each : topic.tags)
    $!{include("tag-label.httl")}
    #end
    <a class="btn_reply" href="javascript:;">回复</a>
  </div>
  <div class="replies">
    #for(reply : replies)
    <div class="reply" data-id="${reply.id}">
      #if(reply.toUser)
      <span style="color: gray">回复 ${reply.toUser.name}:</span>
      #end
      <div>$!{reply.content}</div>
      $!{include("user-label.httl", ["u": reply.author])}
      <span class="human-time" data-time="${reply.whenCreated.time}"></span>
      <span>&nbsp;${reply.floorNumber}楼</span>
      <a class="btn_reply" href="javascript:;">回复</a>
    </div>
    #end
  </div>
</div>

<div id="reply_box" style="display: none">
  <textarea class="reply_input"></textarea>
  <br/>
  <button class="reply_submit" data-url="/topics/${topic.id}/reply">发表</button>
</div>
$!{alljs}
<script>
setup(humanTime_setup, tag_setup, user_setup)
$(document).ready(function() {
  $('.topic-content').each(function(){
    this.innerHTML = marked(this.innerHTML)
  })
  $(document).on('click', '.btn_reply', function(){
    var $rb = $('#reply_box')
    if ($(this).next('#reply_box').length == 0 || $rb.css('display') == 'none') {
      $rb.insertAfter($(this)).show()
    } else{
      $rb.hide()
    }
  })
  $('#reply_box .reply_submit').click(function(){
    var $this = $(this)
    var $input = $('#reply_box .reply_input')
    if ($input.val().length == 0) {
      tipover($this, '请输入内容', 1000)
      return
    }
    var toReplyId = $this.parents('.reply').data('id')
    if (!toReplyId || toReplyId.length == 0) toReplyId = null
    else toReplyId = parseInt(toReplyId)

    $.post($this.data('url'), {
      content: $input.val(),
      toReplyId: toReplyId
    }).done(function(resp){
      tipover($('#reply_box').hide().prev('.btn_reply'), '发表回复成功', 1000)
    }).fail(function(resp){
      tipover($this, '发表回复遇到问题', 1000)
    })
  })
})
</script>
</body>
</html>