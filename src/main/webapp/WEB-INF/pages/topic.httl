<!DOCTYPE html>
<html>
<!--
#set(TopicView topic)
#set(List<TopicReplyView> replies)
-->
<head>
  <meta charset="UTF-8">
  <title>${topic.title}</title>
  $!{allcss}
</head>
<body>
$!{include("navbar.httl")}
<div id="container" class="container">
  <div class="topic" data-id="${topic.id}">
    <span id="id" style="display:none">$!{topic.id}</span>
    <h3 class="title">${topic.title}</h3>
    $!{include("user-label.httl", ["u": topic.author])}
    发表于 $!{spanHumanTime(topic.whenCreated)}
    #if(topic.whenModified)
    修改于 $!{spanHumanTime(topic.whenModified)}
    #end
    浏览数${topic.views}
    <div class="tags">
      #for(each : topic.tags)
      $!{include("tag-label.httl")}
      #end
    </div>
    <div class="content">${topic.content}</div>
    <div>
      <a class="btn_reply" href="javascript:;">回复</a>
      $!{include("btn_like.httl", ["likes": topic.likes, "isLiked": isLiked])}
    </div>
  </div>
  <div class="replies">
    #for(reply : replies)
    <div class="reply" data-id="${reply.id}">
      #if(reply.toUser)
      <span style="color: gray">回复 ${reply.toUser.name}:</span>
      #end
      <div>$!{reply.content}</div>
      $!{include("user-label.httl", ["u": reply.author])}
      $!{spanHumanTime(reply.whenCreated)}
      <span>&nbsp;${reply.floorNumber}楼</span>
      <a class="btn_reply" href="javascript:;">回复</a>
    </div>
    #end
  </div>
</div>

<div id="reply_box" style="display: none">
  <textarea class="reply_input"></textarea>
  <br/>
  <button class="reply_submit" data-url="/topics/${topic.id}/reply">发表</button>
</div>
$!{alljs}
<script>
setup(humanTime_setup, tag_setup, user_setup)
$(document).ready(function() {
  var $content = $('.content').warnEmpty();
  $content.html(marked($content.text()));

  $(document).on('click', '.btn_reply', function(){
    var $rb = $('#reply_box')
    if ($(this).next('#reply_box').length == 0 || $rb.css('display') == 'none') {
      $rb.insertAfter($(this)).show()
    } else{
      $rb.hide()
    }
  })
  $('#reply_box .reply_submit').click(function(){
    var $this = $(this)
    var $input = $('#reply_box .reply_input')
    if ($input.val().length == 0) {
      tipover($this, '请输入内容', 1000)
      return
    }
    var toReplyId = $this.parents('.reply').data('id')
    if (!toReplyId || toReplyId.length == 0) toReplyId = null
    else toReplyId = parseInt(toReplyId)

    $.post($this.data('url'), {
      content: $input.val(),
      toReplyId: toReplyId
    }).done(function(resp){
      tipover($('#reply_box').hide().prev('.btn_reply'), '发表回复成功', 1000)
    }).fail(function(resp){
      tipover($this, '发表回复遇到问题', 1000)
    })
  })

  btnLike_init('/topics/'+$('#id').text())
})
</script>
</body>
</html>